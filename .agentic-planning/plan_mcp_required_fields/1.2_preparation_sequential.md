# 1.2 Подготовка общих компонентов (Sequential)

**Тип:** Sequential (должно быть выполнено перед параллельными этапами)

**Цель:** Подготовить общую инфраструктуру и убедиться, что все необходимые компоненты доступны.

---

## Задачи

### 1. Проверка наличия `FieldsSchema`

- [ ] Проверить, что `FieldsSchema` экспортируется из `@mcp-framework/core`
- [ ] Проверить, что `FieldsSchema` также доступен в `packages/servers/yandex-tracker/src/tools/common/schemas/`
- [ ] Убедиться, что schema правильно валидирует массив строк

**Файлы для проверки:**
- `packages/framework/core/src/tools/common/schemas/fields.schema.ts`
- `packages/servers/yandex-tracker/src/tools/common/schemas/index.ts`

**Ожидаемое поведение:**
```typescript
import { FieldsSchema } from '@mcp-framework/core';
// ИЛИ
import { FieldsSchema } from '../common/schemas/index.js';

const schema = z.object({
  fields: FieldsSchema, // Обязательный массив строк
});
```

---

### 2. Проверка `ResponseFieldFilter`

- [ ] Убедиться, что `ResponseFieldFilter.filter()` корректно работает
- [ ] Проверить поддержку вложенных полей (например, `assignee.login`)
- [ ] Проверить поведение для массивов объектов

**Файл:**
- `packages/framework/core/src/tools/common/response-field-filter.ts`

**Тестовые сценарии:**
```typescript
// Простая фильтрация
ResponseFieldFilter.filter({ a: 1, b: 2, c: 3 }, ['a', 'b'])
// Результат: { a: 1, b: 2 }

// Вложенные поля
ResponseFieldFilter.filter({ user: { login: 'test', email: 'test@test.com' } }, ['user.login'])
// Результат: { user: { login: 'test' } }

// Массивы объектов
const items = [{ id: 1, name: 'A' }, { id: 2, name: 'B' }];
items.map(item => ResponseFieldFilter.filter(item, ['id']))
// Результат: [{ id: 1 }, { id: 2 }]
```

---

### 3. Создание эталонного примера

- [ ] Выбрать один tool в качестве эталона (например, `get_issues`)
- [ ] Убедиться, что он правильно реализует паттерн
- [ ] Зафиксировать паттерн для копирования в другие tools

**Эталонный паттерн:**

**Schema:**
```typescript
import { z } from 'zod';
import { FieldsSchema } from '../../../../common/schemas/index.js';

export const GetXxxParamsSchema = z.object({
  // ... существующие параметры ...

  /**
   * Массив полей для возврата (обязательный)
   * Примеры: ['id', 'name'], ['id', 'assignee.login', 'status.key']
   */
  fields: FieldsSchema,
});
```

**Tool:**
```typescript
import { ResponseFieldFilter } from '@mcp-framework/core';

async execute(params: ToolCallParams): Promise<ToolResult> {
  const validation = this.validateParams(params, GetXxxParamsSchema);
  if (!validation.success) {
    return validation.error;
  }

  const { fields, ...otherParams } = validation.data;

  try {
    // API вызов
    const data = await this.facade.getXxx(otherParams);

    // Фильтрация полей
    const filtered = ResponseFieldFilter.filter(data, fields);

    return this.formatSuccess({
      data: filtered,
      fieldsReturned: fields,
    });
  } catch (error: unknown) {
    return this.formatError('Ошибка при получении данных', error as Error);
  }
}
```

**Для массивов объектов:**
```typescript
const filteredItems = items.map(item =>
  ResponseFieldFilter.filter<EntityWithUnknownFields>(item, fields)
);
```

---

### 4. Проверка тестовой инфраструктуры

- [ ] Убедиться, что можно запускать тесты для отдельных категорий
- [ ] Проверить наличие test helpers для создания mock данных

**Команды:**
```bash
# Тесты для конкретного пакета
npm run test --workspace=@mcp-server/yandex-tracker

# Тесты в quiet режиме (для ИИ)
npm run test:quiet --workspace=@mcp-server/yandex-tracker

# Тесты конкретного файла
npx vitest run packages/servers/yandex-tracker/tests/tools/api/checklists/
```

---

### 5. Создание шаблона для валидации

- [ ] Создать checklist для проверки каждого tool
- [ ] Подготовить список файлов для каждой категории

**Шаблон валидации для каждого tool:**

```markdown
## Tool: {tool_name}

### Schema файл: `{path}`
- [ ] Импортирован `FieldsSchema`
- [ ] Добавлен параметр `fields: FieldsSchema` (обязательный, НЕ optional)
- [ ] TypeScript компилируется без ошибок

### Tool файл: `{path}`
- [ ] Импортирован `ResponseFieldFilter`
- [ ] Извлекается `fields` из validation.data
- [ ] Используется `ResponseFieldFilter.filter(data, fields)`
- [ ] Убрана ручная фильтрация (если была)
- [ ] В ответе указано `fieldsReturned: fields`

### Definition файл: `{path}`
- [ ] Обновлено описание параметра `fields`
- [ ] Добавлены примеры использования

### Тесты
- [ ] Все существующие тесты обновлены (добавлен `fields`)
- [ ] Тесты проходят (`npm run test:quiet`)
- [ ] TypeScript валидация проходит (`npm run typecheck`)
```

---

## Критерии завершения этапа

- ✅ `FieldsSchema` доступен и работает корректно
- ✅ `ResponseFieldFilter` протестирован и работает
- ✅ Создан эталонный пример для копирования
- ✅ Тестовая инфраструктура готова
- ✅ Шаблоны валидации подготовлены

---

## Следующий шаг

После завершения подготовки можно переходить к параллельным этапам 2.1-2.8
